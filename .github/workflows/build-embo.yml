name: Build EMBO

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: embo
            asset_name: embo-linux-x64
          - os: macos-latest
            artifact_name: embo
            asset_name: embo-macos-x64
          - os: windows-latest
            artifact_name: embo.exe
            asset_name: embo-windows-x64.exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Set up build environment (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake

    - name: Set up build environment (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake --yes

    - name: Debug - List directory structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Subdirectories:"
        find . -maxdepth 2 -type d | head -20

    - name: Create build directory
      run: |
        mkdir -p build
        cd build
        cmake ..

    - name: Build project
      run: |
        cd build
        cmake --build . --config Release

    - name: Debug - Find binaries (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Searching for build artifacts..."
        find . -type f -name "embo" -o -name "*.so" -o -name "*.a" | head -20
        echo "Build directory contents:"
        ls -la build/ || true
        echo "Contents of build subdirectories:"
        find build -type f | head -30

    - name: Debug - Find binaries (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Searching for build artifacts..."
        Get-ChildItem -Recurse -Filter "*.exe" | Select-Object FullName | Format-Table -AutoSize
        Write-Host "Build directory contents:"
        Get-ChildItem -Path "build" -Recurse | Format-Table FullName
        Write-Host "Contents of Release folder:"
        Get-ChildItem -Path "build\Release" -Recurse -ErrorAction SilentlyContinue | Format-Table FullName

    - name: Locate binary (Unix)
      if: runner.os != 'Windows'
      id: locate_binary
      run: |
        # Search for the binary in common locations
        BINARY_PATH=""
        
        # Check common build output locations
        for path in build/embo build/Release/embo build/src/embo ./embo; do
          if [ -f "$path" ]; then
            BINARY_PATH="$path"
            break
          fi
        done
        
        if [ -z "$BINARY_PATH" ]; then
          echo "ERROR: Binary not found in expected locations"
          echo "Searching entire build directory..."
          BINARY_PATH=$(find build -name "embo" -type f | head -1)
        fi
        
        if [ -f "$BINARY_PATH" ]; then
          echo "Binary found at: $BINARY_PATH"
          echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT
          chmod +x "$BINARY_PATH"
        else
          echo "ERROR: Could not locate embo binary"
          exit 1
        fi

    - name: Locate binary (Windows)
      if: runner.os == 'Windows'
      id: locate_binary_win
      shell: powershell
      run: |
        # Search for the binary in common locations
        $binaryPath = ""
        
        $searchPaths = @(
          "build\embo.exe",
          "build\Release\embo.exe",
          "build\src\embo.exe",
          ".\embo.exe"
        )
        
        foreach ($path in $searchPaths) {
          if (Test-Path $path) {
            $binaryPath = $path
            break
          }
        }
        
        if ([string]::IsNullOrEmpty($binaryPath)) {
          Write-Host "Binary not found in expected locations, searching recursively..."
          $binaryPath = Get-ChildItem -Recurse -Name "embo.exe" -Path "build" | Select-Object -First 1
          if ($null -ne $binaryPath) {
            $binaryPath = "build\$binaryPath"
          }
        }
        
        if (Test-Path $binaryPath) {
          Write-Host "Binary found at: $binaryPath"
          echo "binary_path=$binaryPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        } else {
          Write-Host "ERROR: Could not locate embo.exe binary"
          exit 1
        }

    - name: Verify binary (Unix)
      if: runner.os != 'Windows'
      run: |
        BINARY_PATH="${{ steps.locate_binary.outputs.binary_path }}"
        if [ -f "$BINARY_PATH" ]; then
          echo "Binary exists: $BINARY_PATH"
          echo "Binary size: $(stat -f%z "$BINARY_PATH" 2>/dev/null || stat -c%s "$BINARY_PATH")"
          echo "Binary is executable: $([ -x "$BINARY_PATH" ] && echo 'Yes' || echo 'No')"
          echo "Attempting to run binary with --version or --help:"
          "$BINARY_PATH" --version 2>/dev/null || "$BINARY_PATH" --help 2>/dev/null || echo "Binary executed (no version flag available)"
        else
          echo "ERROR: Binary not found at $BINARY_PATH"
          exit 1
        fi

    - name: Verify binary (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        $binaryPath = "${{ steps.locate_binary_win.outputs.binary_path }}"
        if (Test-Path $binaryPath) {
          Write-Host "Binary exists: $binaryPath"
          $size = (Get-Item $binaryPath).Length
          Write-Host "Binary size: $size bytes"
          Write-Host "Attempting to run binary with --version or --help:"
          & $binaryPath --version 2>$null || & $binaryPath --help 2>$null || Write-Host "Binary executed (no version flag available)"
        } else {
          Write-Host "ERROR: Binary not found at $binaryPath"
          exit 1
        }

    - name: Create assets directory
      run: |
        mkdir -p assets

    - name: Package binary (Unix)
      if: runner.os != 'Windows'
      run: |
        BINARY_PATH="${{ steps.locate_binary.outputs.binary_path }}"
        ASSET_NAME="${{ matrix.asset_name }}"
        cp "$BINARY_PATH" "assets/$ASSET_NAME"
        chmod +x "assets/$ASSET_NAME"
        echo "Assets created:"
        ls -lh assets/

    - name: Package binary (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        $binaryPath = "${{ steps.locate_binary_win.outputs.binary_path }}"
        $assetName = "${{ matrix.asset_name }}"
        Copy-Item $binaryPath -Destination "assets\$assetName"
        Write-Host "Assets created:"
        Get-ChildItem -Path "assets" -Recurse | Format-Table FullName, Length

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.asset_name }}
        path: assets/${{ matrix.asset_name }}
        retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          embo-linux-x64/embo-linux-x64
          embo-macos-x64/embo-macos-x64
          embo-windows-x64.exe/embo-windows-x64.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
