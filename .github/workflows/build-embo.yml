name: Build EMBO (Standalone)

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 180  # Build static Qt may take longer

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # ---------------- LINUX ----------------
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        set -euo pipefail
        sudo apt-get update
        # Install build tools and static FFTW
        sudo apt-get install -y build-essential qt5-qmake qtbase5-dev qttools5-dev-tools libqt5serialport5-dev libgl1-mesa-dev libfftw3-dev pkg-config
        # Ensure static libraries exist
        if [ ! -f /usr/lib/x86_64-linux-gnu/libfftw3.a ]; then
          echo "Static FFTW library not found; aborting"
          exit 1
        fi

    # ---------------- MACOS ----------------
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        set -euo pipefail
        brew update
        brew install pkg-config fftw || true
        # Qt static must be prebuilt; set QMAKE path
        QT_STATIC_PATH=$(brew --prefix qt@5)/libexec
        echo "$QT_STATIC_PATH" >> $GITHUB_PATH
        if ! command -v qmake >/dev/null 2>&1; then
          echo "qmake not found; aborting"
          exit 1
        fi

    # ---------------- WINDOWS ----------------
    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        choco install -y visualcpp-build-tools || Write-Host "Visual C++ tools may exist"
        # Install Qt static manually; runner may have Qt already
        # User must ensure Qt static exists
        $qmake = Get-Command qmake.exe -ErrorAction SilentlyContinue
        if (-not $qmake) { throw "qmake not found; static Qt required" }

    # ---------------- BUILD ----------------
    - name: Build EMBO (Linux / macOS)
      if: ${{ matrix.os != 'windows-latest' }}
      shell: bash
      run: |
        set -euo pipefail
        cd src/software/EMBO
        qmake CONFIG+=release static
        CORES=$(nproc || echo 2)
        make -j"$CORES"

    - name: Setup MSVC environment (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build EMBO (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        cd src/software/EMBO
        $qmakeCmd = Get-Command qmake.exe -ErrorAction SilentlyContinue
        & $qmakeCmd.Path CONFIG+=release static
        if (Get-Command nmake.exe -ErrorAction SilentlyContinue) {
          nmake
        } elseif (Get-Command mingw32-make.exe -ErrorAction SilentlyContinue) {
          mingw32-make -j2
        } else {
          throw "No make tool found (nmake or mingw32-make)"
        }

    # ---------------- ARTIFACT ----------------
    - name: Upload standalone artifact
      uses: actions/upload-artifact@v4
      with:
        name: EMBO-Standalone-${{ matrix.os }}
        path: |
          src/software/EMBO
