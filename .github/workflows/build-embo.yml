name: Build EMBO (Stable)

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # ---------------- LINUX ----------------
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          qt5-qmake \
          qtbase5-dev \
          qttools5-dev-tools \
          libqt5serialport5-dev \
          libgl1-mesa-dev \
          libfftw3-dev \
          pkg-config

    # ---------------- MACOS ----------------
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        set -euo pipefail
        brew update
        brew install qt@5 fftw pkg-config || true
        echo "$(brew --prefix qt@5)/libexec" >> $GITHUB_PATH
        # Verify qmake
        if ! command -v qmake >/dev/null 2>&1; then
          echo "qmake not found after installing qt@5"
          exit 1
        fi

    # ---------------- WINDOWS ----------------
    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        choco install -y visualcpp-build-tools || Write-Host "May already be present"
        choco install -y qt5 --version=5.15.2 || choco install -y qt --version=5.15.2 || Write-Host "Qt install via choco may fail"
        choco install -y fftw || Write-Host "fftw may fail or already present"
        refreshenv

        # Find qmake.exe
        $qmake = Get-Command qmake.exe -ErrorAction SilentlyContinue
        if (-not $qmake) {
          $found = Get-ChildItem -Path 'C:\Program Files\Qt','C:\Qt','C:\Program Files (x86)\Qt' -Filter qmake.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) {
            Write-Host "Found qmake at $($found.FullName). Adding to PATH"
            Write-Host "$(Split-Path $found.FullName -Parent)" >> $env:GITHUB_PATH
            refreshenv
          } else {
            throw "qmake not found on Windows"
          }
        }

    # ---------------- BUILD (Linux / macOS) ----------------
    - name: Build EMBO (Linux / macOS)
      if: ${{ matrix.os != 'windows-latest' }}
      shell: bash
      run: |
        set -euo pipefail
        cd src/software/EMBO
        if ! command -v qmake >/dev/null 2>&1; then
          echo "qmake not found; aborting build"
          exit 1
        fi
        qmake
        CORES=$(nproc || echo 2)
        make -j"$CORES"

    # ---------------- BUILD (Windows) ----------------
    - name: Setup MSVC environment (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build EMBO (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        cd src/software/EMBO

        $qmakeCmd = Get-Command qmake.exe -ErrorAction SilentlyContinue
        if (-not $qmakeCmd) { throw "qmake not found" }
        & $qmakeCmd.Path

        if (Get-Command nmake.exe -ErrorAction SilentlyContinue) {
          nmake
        } elseif (Get-Command mingw32-make.exe -ErrorAction SilentlyContinue) {
          mingw32-make -j2
        } else {
          throw "No make tool found (nmake or mingw32-make)"
        }

    # ---------------- ARTIFACTS ----------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EMBO-${{ matrix.os }}
        path: |
          src/software/EMBO
