name: Build EMBO (System Qt)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-12]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    # Ensure a known Python runtime is present (helps actions that rely on python)
    - name: Setup Python (ensure runtime)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Debug python / environment early so we can capture the failure reason
    - name: Debug Python (Linux/macOS)
      if: matrix.os == 'ubuntu-22.04' || matrix.os == 'macos-12'
      run: |
        whoami
        uname -a
        python3 --version || python --version
        which python3 || which python || echo "no python found in PATH"
        echo "PATH=$PATH"

    - name: Debug Python (Windows)
      if: matrix.os == 'windows-2022'
      run: |
        Write-Host "User: $(whoami)"
        Write-Host "OS info:"
        Get-CimInstance Win32_OperatingSystem | Select-Object Caption, OSArchitecture
        python --version
        where.exe python || Write-Host "no python found in PATH"
        Write-Host "PATH=$env:PATH"
      shell: pwsh

    # -------- Linux --------
    - name: Install Qt (Linux)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt update
        sudo apt install -y \
          qtbase5-dev \
          qtserialport5-dev \
          libfftw3-dev \
          build-essential

    # -------- macOS --------
    - name: Install Qt (macOS)
      if: matrix.os == 'macos-12'
      run: |
        brew update
        brew install qt@5 fftw
        echo "$(brew --prefix qt@5)/bin" >> $GITHUB_PATH

    # -------- Windows --------
    - name: Install Qt (Windows)
      if: matrix.os == 'windows-2022'
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.15.2'
        # optionally specify arch or host if needed, e.g. host: windows, arch: x64

    - name: Setup MSVC
      if: matrix.os == 'windows-2022'
      uses: ilammy/msvc-dev-cmd@v1

    # -------- Build --------
    - name: Build EMBO
      run: |
        cd src/software/EMBO
        qmake
        make -j$(nproc || sysctl -n hw.ncpu)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EMBO-${{ matrix.os }}
        path: src/software/EMBO
